<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>lua学习 | ShallWe Talk</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">lua学习</h1><a id="logo" href="/.">ShallWe Talk</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">lua学习</h1><div class="post-meta">Oct 28, 2017<span> | </span><span class="category"><a href="/categories/lua/">lua</a></span></div><div class="post-content"><h2 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">a = <span class="literal">nil</span></div><div class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a)) <span class="comment">-- nil</span></div><div class="line">a = <span class="number">1</span></div><div class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a)) <span class="comment">-- number</span></div><div class="line">a = <span class="string">"hah"</span></div><div class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a)) <span class="comment">-- string</span></div><div class="line">a = <span class="literal">true</span></div><div class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a)) <span class="comment">-- boolean</span></div><div class="line">a = &#123;&#125;</div><div class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a)) <span class="comment">-- table</span></div><div class="line">a = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">end</span></div><div class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a)) <span class="comment">-- function</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><h3 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h3><blockquote>
<p>and or not</p>
</blockquote>
<p>false和nil是false, 其它是true（0也是true）</p>
<p>如果x为false或nil则给x赋初值v</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">x = x <span class="keyword">or</span> v</div></pre></td></tr></table></figure>
<p>三元运算符<code>a?b:c</code><br>在lua里是</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(a <span class="keyword">and</span> b) <span class="keyword">or</span> c</div></pre></td></tr></table></figure>
<h3 id="连接运算符"><a href="#连接运算符" class="headerlink" title="连接运算符"></a>连接运算符</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">..   <span class="comment">-- 两个点</span></div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="string">"Hello "</span> .. <span class="string">"World"</span>)  <span class="comment">--&gt; Hello World</span></div><div class="line"><span class="built_in">print</span>(<span class="number">0</span> .. <span class="number">1</span>)               <span class="comment">--&gt; 01</span></div></pre></td></tr></table></figure>
<h2 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h2><ul>
<li>if 语句</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(a)</span></span></div><div class="line">	<span class="keyword">if</span> a &gt; <span class="number">10</span> <span class="keyword">then</span></div><div class="line">		<span class="built_in">print</span>(<span class="string">"a &gt; 10"</span>)</div><div class="line">	<span class="keyword">elseif</span> a &gt; <span class="number">0</span> <span class="keyword">then</span></div><div class="line">		<span class="built_in">print</span>(<span class="string">"a = "</span> .. a)</div><div class="line">	<span class="keyword">else</span></div><div class="line">		<span class="built_in">print</span>(<span class="string">"a &lt; 0"</span>)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">show(<span class="number">15</span>) <span class="comment">-- a &gt; 10</span></div><div class="line">show(<span class="number">5</span>)  <span class="comment">-- a = 5</span></div><div class="line">show(<span class="number">-5</span>) <span class="comment">-- a &lt; 0</span></div></pre></td></tr></table></figure>
<ul>
<li>while 语句</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(a)</span></span></div><div class="line">	<span class="keyword">while</span> a &gt; <span class="number">10</span> <span class="keyword">do</span></div><div class="line">		a = a / <span class="number">2</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	<span class="built_in">print</span>(a)</div><div class="line"><span class="keyword">end</span></div><div class="line">show(<span class="number">15</span>) <span class="comment">-- 7.5</span></div><div class="line">show(<span class="number">5</span>)  <span class="comment">-- 5</span></div></pre></td></tr></table></figure>
<ul>
<li>repeat until 语句</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(a)</span></span></div><div class="line">	<span class="keyword">repeat</span> a = a * <span class="number">2</span> <span class="keyword">until</span> a &gt; <span class="number">100</span></div><div class="line">	<span class="built_in">print</span>(a)</div><div class="line"><span class="keyword">end</span></div><div class="line">show(<span class="number">15</span>)  <span class="comment">-- 120</span></div><div class="line">show(<span class="number">5</span>)   <span class="comment">-- 160</span></div><div class="line">show(<span class="number">101</span>) <span class="comment">-- 202</span></div></pre></td></tr></table></figure>
<ul>
<li>for 语句（若以下三个参数被写成了表达式的形式，表达式只会被调用一次，且调用时间在循环开始前）<ul>
<li>初值</li>
<li>终止值</li>
<li>步长（默认为1）</li>
</ul>
</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">8</span>, <span class="number">3</span> <span class="keyword">do</span></div><div class="line">	<span class="built_in">print</span>(<span class="string">"i = "</span> .. i)</div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="comment">-- i = 1</span></div><div class="line"><span class="comment">-- i = 4</span></div><div class="line"><span class="comment">-- i = 7</span></div></pre></td></tr></table></figure>
<ul>
<li>泛型for<ol>
<li>初始化，计算in后面表达式的值，表达式应该返回泛型for需要的三个值：迭代函数、状态常量、控制变量；如果返回值个数不够，用nil补足，多出被忽略</li>
<li>将状态常量和控制变量作为参数调用迭代函数</li>
<li>将迭代函数返回值赋给变量列表</li>
<li>如果返回的第一个值为nil，循环结束，否则执行循环体</li>
<li>回到2再次调用迭代函数</li>
</ol>
</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">a = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, hello = <span class="string">"lua"</span>, world = <span class="string">"world"</span>&#125;</div><div class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></div><div class="line">	<span class="built_in">print</span>(i .. <span class="string">" "</span> .. v)</div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="comment">-- 1 1</span></div><div class="line"><span class="comment">-- 2 2</span></div><div class="line"><span class="comment">-- 3 3</span></div><div class="line"><span class="comment">-- hello lua</span></div><div class="line"><span class="comment">-- world world</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>ipairs(t)</strong>：遇到nil则退出，只能对顺序表访问</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">table</span>=&#123;[<span class="number">2</span>]=<span class="number">3</span>, hello=<span class="string">"hello"</span>&#125; <span class="comment">--&gt; key为1的时候value为nil 所以退出了</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(<span class="built_in">table</span>) <span class="keyword">do</span></div><div class="line">    <span class="built_in">print</span>(i, v)</div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="comment">--&gt; 没有输出</span></div></pre></td></tr></table></figure>
<ul>
<li><strong>pairs(t)</strong>：可以遍历表中所有key，可以对dict访问</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">table</span>=&#123;hello=<span class="string">"hello"</span>&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">table</span>) <span class="keyword">do</span></div><div class="line">    <span class="built_in">print</span>(i, v)</div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="comment">--&gt; hello hello</span></div></pre></td></tr></table></figure>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><ul>
<li>可返回多个结果</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">"Hello Lua"</span>, <span class="string">"Lua"</span>) <span class="comment">-- 返回开始和结束的下标</span></div><div class="line"><span class="built_in">print</span>(s, e)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">maximum</span><span class="params">(a)</span></span></div><div class="line">    <span class="keyword">local</span> mi = <span class="number">1</span>    <span class="comment">-- maximum index</span></div><div class="line">    <span class="keyword">local</span> m = a[mi] <span class="comment">-- maximum value</span></div><div class="line">    <span class="keyword">for</span> i, val <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></div><div class="line">        <span class="keyword">if</span> val &gt; m <span class="keyword">then</span></div><div class="line">            mi = i</div><div class="line">            m = val</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="keyword">return</span> m, mi</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="built_in">print</span>(maximum(&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;)) <span class="comment">--&gt; 5 5</span></div></pre></td></tr></table></figure>
<ul>
<li>可变参数</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">f = <span class="built_in">string</span>.<span class="built_in">find</span></div><div class="line">a = &#123;<span class="string">"Hello Lua"</span>, <span class="string">"Lua"</span>&#125;</div><div class="line"><span class="built_in">print</span>(f(<span class="built_in">table</span>.<span class="built_in">unpack</span>(a))) <span class="comment">-- 5.2之后unpack被移到了table下</span></div><div class="line"></div><div class="line"></div><div class="line">printResult = <span class="string">""</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">link</span><span class="params">(...)</span></span></div><div class="line">    <span class="keyword">local</span> <span class="built_in">arg</span> = &#123; ... &#125;  <span class="comment">-- 5.1之后需要手动把...变成arg了</span></div><div class="line">    <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(<span class="built_in">arg</span>) <span class="keyword">do</span></div><div class="line">        printResult = printResult .. <span class="built_in">tostring</span>(v) .. <span class="string">"\t"</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    printResult = printResult .. <span class="string">"\n"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">link(<span class="string">"a"</span>, <span class="string">"b"</span>)</div><div class="line"><span class="built_in">print</span>(printResult)</div></pre></td></tr></table></figure>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>当一个函数内部嵌套另一个函数定义时，内部函数体可以访问外部函数体的局部变量，这种特征称为词法定界。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">names = &#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>&#125;</div><div class="line">grades = &#123;c = <span class="number">10</span>, b = <span class="number">7</span>, a = <span class="number">8</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortbygrade</span> <span class="params">(names, grades)</span></span></div><div class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span> <span class="params">(n1, n2)</span></span></div><div class="line">        <span class="keyword">return</span> grades[n1] &gt; grades[n2]</div><div class="line">    <span class="keyword">end</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">sortbygrade (names, grades)</div><div class="line"></div><div class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(names) <span class="keyword">do</span></div><div class="line">    <span class="built_in">print</span>(v)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">--&gt; c a b</span></div></pre></td></tr></table></figure>
<p>闭包是一个函数加上它可以正确访问的upvalues。闭包指值而不是函数，函数仅仅是闭包的一个原型声明。<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">newCounter</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">local</span> i = <span class="number">0</span>       <span class="comment">--&gt; upvalue</span></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></div><div class="line">        i = i + <span class="number">1</span>     <span class="comment">--&gt; 虽然已经超出了local i的作用范围 但由于闭包的思想 成功访问了</span></div><div class="line">        <span class="keyword">return</span> i</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">c1 = newCounter()</div><div class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 1</span></div><div class="line"><span class="built_in">print</span>(c1())  <span class="comment">--&gt; 2</span></div></pre></td></tr></table></figure></p>
<ul>
<li><p>闭包的应用</p>
<ol>
<li>作为高阶函数的参数（table.sort的参数）</li>
<li>创建其他函数的函数（函数返回一个闭包）</li>
<li>回调函数（界面上按钮的回调）</li>
<li>创建一个安全的运行环境（比如要限制一个程序访问文件，可以用闭包来重定义io.open）</li>
<li>实现迭代器</li>
</ol>
</li>
<li><p>闭包的实现原理</p>
</li>
</ul>
<p>Lua编译一个函数（编译期概念）时，会为他生成一个原型(prototype)，其中包含函数对应的虚拟机指令、函数用到的常量和一些调试信息。<br>运行时，每当Lua执行一个形如<code>function...end</code>的表达式时，会创建一个新的数据对象，其中包含相应函数原型的<em>引用</em>及一个由所有upvalue引用组成的数组。这个数据对象称为闭包（运行时概念）。上述数组中的每个元素都是一个对upvalue的引用，可以通过该数据来访问外部局部变量。在Lua5.2之前，闭包中还包括一个对环境(environment)的引用，环境实质就是一个table，函数可以在该表中索引全局变量，从Lua5.2开始取消了闭包中的环境，引入_ENV来设置闭包环境。</p>
<p>upvalue初始存在栈上，由指针指向，当运行时，离开变量作用域时，会复制到upvalue的结构中去，改变指针的位置到upvalue结构中对应位置。Lua维护一条链表，该链表中每个节点对应一个打开的upvalue结构，打开的upvalue是指当前正指向栈局部变量的upvalue。当Lua创建一个新闭包时，会遍历当前函数所有的外部的局部变量，对于每个外部的局部变量，若在上述链表中能找到该变量，则重复使用该打开的upvalue，否则，Lua会创建一个新的打开的upvalue，并插入链表中。当局部变量离开作用域（即超过变量生命周期），这个打开的upvalue就会变成关闭的upvalue，并把它从链表中删除。一旦某个关闭的upvalue不再被任何闭包引用，那么它的存储空间就被回收。</p>
<p>一个函数有可能存取其更外层函数而非直接外层函数的局部变量。在这种情况下，创建闭包时，这个局部变量可能不在栈中。Lua使用flat闭包来处理这种情况。使用flat闭包，无论何时一个函数访问一个外部的局部变量并且该变量不在直接外部函数中，该变量也会进入直接外部函数的闭包中。当一个函数被实例化时，其对应闭包的所有变量要么在直接外部函数的栈中要么在直接外部函数的闭包中。</p>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">co = coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>  <span class="comment">-- 挂起态</span></div><div class="line">    <span class="built_in">print</span>(<span class="string">"Hello"</span>)</div><div class="line"><span class="keyword">end</span>)</div><div class="line"><span class="built_in">print</span>(coroutine.<span class="built_in">status</span>(co)) <span class="comment">--&gt; suspended</span></div><div class="line">coroutine.<span class="built_in">resume</span>(co) <span class="comment">--&gt;hello （挂起-&gt;运行）</span></div><div class="line"><span class="built_in">print</span>(coroutine.<span class="built_in">status</span>(co)) <span class="comment">--&gt; dead</span></div></pre></td></tr></table></figure>
<ul>
<li><code>coroutine.create()</code> 创建</li>
<li><code>coroutine.resume()</code> 继续</li>
<li><code>coroutine.status()</code> 查看状态：suspend, running, dead</li>
<li><code>coroutine.yield()</code> 挂起</li>
<li><code>coroutine.wrap()</code> 创建（与create返回协程本身不同，wrap返回函数，创建完直接调用，无法查看状态）</li>
<li><code>coroutine.running()</code> 返回当前正在运行的协程</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">-- 生产者消费者</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">receive</span> <span class="params">(prod)</span></span></div><div class="line">    <span class="keyword">local</span> <span class="built_in">status</span>, value = coroutine.<span class="built_in">resume</span>(prod)</div><div class="line">    <span class="keyword">return</span> value</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span> <span class="params">(x)</span></span></div><div class="line">    coroutine.<span class="built_in">yield</span>(x)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">producer</span> <span class="params">()</span></span></div><div class="line">    <span class="keyword">return</span> coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></div><div class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></div><div class="line">            <span class="keyword">local</span> x = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- produce new value</span></div><div class="line">            send(x)</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span> <span class="params">(prod)</span></span>  <span class="comment">-- 加上行号</span></div><div class="line">    <span class="keyword">return</span> coroutine.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></div><div class="line">        <span class="keyword">local</span> line = <span class="number">1</span></div><div class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></div><div class="line">            <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></div><div class="line">            x = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"%5d %s"</span>, line, x)</div><div class="line">            send(x) <span class="comment">-- send it to consumer</span></div><div class="line">            line = line + <span class="number">1</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">consumer</span> <span class="params">(prod)</span></span></div><div class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></div><div class="line">        <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></div><div class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(x, <span class="string">"\n"</span>) <span class="comment">-- consume new value</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">p = producer()</div><div class="line">f = filter(p)</div><div class="line">consumer(f)</div></pre></td></tr></table></figure>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p> table是lua中唯一的数据结构，arrays, records, lists, queus, sets都用table实现</p>
<ul>
<li>链表</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">list = <span class="literal">nil</span></div><div class="line">list = &#123;<span class="built_in">next</span> = list, value = <span class="number">3</span>&#125; <span class="comment">-- 插入一个值为3的节点</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> l = list</div><div class="line"><span class="keyword">while</span> l <span class="keyword">do</span></div><div class="line">    <span class="built_in">print</span>(l.value)</div><div class="line">    l = l.<span class="built_in">next</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<ul>
<li>字符串缓冲</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">newStack</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">return</span> &#123;<span class="string">""</span>&#125;</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="built_in">_VERSION</span>, <span class="string">"5.3"</span>) <span class="keyword">then</span> <span class="comment">--lua5.0以后没有table.getn了</span></div><div class="line">    <span class="built_in">table</span>.<span class="built_in">getn</span> = <span class="function"><span class="keyword">function</span><span class="params">(t)</span></span></div><div class="line">        <span class="keyword">if</span> t.n <span class="keyword">then</span></div><div class="line">            <span class="keyword">return</span> t.n</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">local</span> n = <span class="number">0</span></div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></div><div class="line">                <span class="keyword">if</span> <span class="built_in">type</span>(i) == <span class="string">"number"</span> <span class="keyword">then</span></div><div class="line">                    n = <span class="built_in">math</span>.<span class="built_in">max</span>(n, i)</div><div class="line">                <span class="keyword">end</span></div><div class="line">            <span class="keyword">end</span></div><div class="line">        <span class="keyword">return</span> n</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addString</span><span class="params">(stack, s)</span></span></div><div class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(stack, s)</div><div class="line">    <span class="keyword">for</span> i = <span class="built_in">table</span>.<span class="built_in">getn</span>(stack)<span class="number">-1</span>, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></div><div class="line">        <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i]) &lt; <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i+<span class="number">1</span>]) <span class="keyword">then</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">        stack[i] = stack[i] .. <span class="built_in">table</span>.<span class="built_in">remove</span>(stack)</div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">stack = newStack()</div><div class="line">addString(stack, <span class="string">"hello "</span>)</div><div class="line">addString(stack, <span class="string">"world"</span>)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(stack[<span class="built_in">table</span>.<span class="built_in">getn</span>(stack)])</div></pre></td></tr></table></figure>
<h2 id="Metatables"><a href="#Metatables" class="headerlink" title="Metatables"></a>Metatables</h2><p>Metatables允许我们改变table的行为，例如可以对两个table进行相加的操作。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">a = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</div><div class="line">b = &#123;<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;</div><div class="line">mt = &#123;&#125;</div><div class="line"><span class="built_in">setmetatable</span>(a, mt)</div><div class="line"><span class="built_in">setmetatable</span>(b, mt)</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mt.__add</span><span class="params">(c, d)</span></span> <span class="comment">-- 这里是一个双下划线</span></div><div class="line">    <span class="keyword">local</span> t = &#123;&#125;</div><div class="line">    <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(c) <span class="keyword">do</span></div><div class="line">        t[#t + <span class="number">1</span>] = v</div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(d) <span class="keyword">do</span></div><div class="line">        t[#t + <span class="number">1</span>] = v</div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="keyword">return</span> t</div><div class="line"><span class="keyword">end</span></div><div class="line">a = a + b</div><div class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></div><div class="line">    <span class="built_in">print</span>(v)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>任何一个表都可以是其他一个表的metatable，一组相关的表可以共享一个metatable（描述他们共同的行为）。一个表也可以是自身的metatable（描述其私有行为）</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li>LUA中文教程</li>
<li><a href="http://blog.csdn.net/maximuszhou/article/details/44280109" target="_blank" rel="external">深入理解Lua的闭包一：概念、应用和实现原理(CSDN)</a></li>
</ol>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/10/28/unity-eventfunction/" class="pre">unity_eventfunction</a><a href="/2017/07/08/unity-animation/" class="next">unity-animation</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Beijing/">Beijing</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C语言学习笔记/">C语言学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/RDD/">RDD</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/RDD/source-code/">source code</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/configuration/">configuration</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/coding/">coding</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/coding/compiler/">compiler</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/dp/">dp</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/language/">language</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/language/Japanese/">Japanese</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/language/Japanese/lyric/">lyric</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/HashTable/">HashTable</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/Two-Pointers/">Two Pointers</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/divide-and-conquer/">divide and conquer</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/dp/">dp</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mapreduce/">mapreduce</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/music/">music</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/music/guitar/">guitar</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/paper/">paper</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/paper/NLP/">NLP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/paper/scheduler/">scheduler</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming-language/">programming language</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/python/matplotlib/">matplotlib</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/software-engineer/">software engineer</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/software-engineer/API/">API</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/source-code/">source code</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/source-code/JXIO/">JXIO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/source-code/Spark/">Spark</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/spark/">spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/unity/">unity</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/unity/animation/">animation</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/28/unity-eventfunction/">unity_eventfunction</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/28/learn-lua/">lua学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/08/unity-animation/">unity-animation</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/09/dynamic-resource-allocation/">Dynamic Resource Allocation</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/06/swprintf/">来聊一聊C++的string</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/13/beijing/">出去玩-北京</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/31/running-spark-on-mesos/">Running Spark on Mesos</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/12/spark-summary/">Spark小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/25/the-number-of-the-increasing-sub-sequences/">一个数组的递增子序列的个数</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/13/factorial-nonzero-suffix/">求N!的后9位不为0的数</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">ShallWe Talk.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><script src="//dn-lbstatics.qbox.me/lbservice/busuanzi/2.0/busuanzi.mini.js"/></script>
<span id="busuanzi_container_site_uv">已经有<span id="busuanzi_value_site_uv"></span>人次访问carolz的小站啦 ( •̀ ω •́ )y</span></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>